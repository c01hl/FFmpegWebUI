<div class="log-viewer">
    <div class="log-header">
        <span class="log-title">ğŸ“œ FFmpeg æ—¥å¿—</span>
        <div class="log-actions">
            <input type="text" 
                   placeholder="æœç´¢..." 
                   @bind="_searchText"
                   @bind:event="oninput"
                   class="search-input" />
            <button class="btn-icon" title="å¤åˆ¶æ—¥å¿—" @onclick="CopyLog">ğŸ“‹</button>
            <button class="btn-icon" title="æ¸…ç©º" @onclick="Clear">ğŸ—‘ï¸</button>
            <label class="auto-scroll">
                <input type="checkbox" @bind="_autoScroll" /> è‡ªåŠ¨æ»šåŠ¨
            </label>
        </div>
    </div>

    <div class="log-content" @ref="_logContainer">
        @if (_filteredLines.Count == 0)
        {
            <div class="empty-log">æš‚æ— æ—¥å¿—è¾“å‡º</div>
        }
        else
        {
            @foreach (var (line, index) in _filteredLines.Select((l, i) => (l, i)))
            {
                <div class="log-line @GetLineClass(line)">
                    <span class="line-number">@(index + 1)</span>
                    <span class="line-content">@HighlightSearch(line)</span>
                </div>
            }
        }
    </div>

    <div class="log-footer">
        <span>å…± @_lines.Count è¡Œ</span>
        @if (!string.IsNullOrEmpty(_searchText))
        {
            <span>| åŒ¹é… @_filteredLines.Count è¡Œ</span>
        }
    </div>
</div>

@code {
    private List<string> _lines = [];
    private string _searchText = string.Empty;
    private bool _autoScroll = true;
    private ElementReference _logContainer;

    [Parameter]
    public string LogText { get; set; } = string.Empty;

    [Parameter]
    public int MaxLines { get; set; } = 1000;

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    private List<string> _filteredLines => string.IsNullOrEmpty(_searchText)
        ? _lines
        : _lines.Where(l => l.Contains(_searchText, StringComparison.OrdinalIgnoreCase)).ToList();

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(LogText))
        {
            _lines = LogText.Split('\n', StringSplitOptions.RemoveEmptyEntries)
                .TakeLast(MaxLines)
                .ToList();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_autoScroll && _logContainer.Id != null)
        {
            try
            {
                await JS.InvokeVoidAsync("eval", 
                    $"document.querySelector('.log-content')?.scrollTo(0, document.querySelector('.log-content')?.scrollHeight)");
            }
            catch
            {
                // å¿½ç•¥ JS è°ƒç”¨å¼‚å¸¸
            }
        }
    }

    public void AppendLine(string line)
    {
        _lines.Add(line);
        if (_lines.Count > MaxLines)
        {
            _lines.RemoveAt(0);
        }
        StateHasChanged();
    }

    public void Clear()
    {
        _lines.Clear();
        StateHasChanged();
    }

    private async Task CopyLog()
    {
        try
        {
            var text = string.Join("\n", _filteredLines);
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
        }
        catch
        {
            // å‰ªè´´æ¿è®¿é—®å¯èƒ½è¢«æ‹’ç»
        }
    }

    private static string GetLineClass(string line)
    {
        if (line.Contains("error", StringComparison.OrdinalIgnoreCase) ||
            line.Contains("failed", StringComparison.OrdinalIgnoreCase))
            return "error";
        if (line.Contains("warning", StringComparison.OrdinalIgnoreCase))
            return "warning";
        if (line.Contains("time=") || line.Contains("speed="))
            return "progress";
        return "";
    }

    private MarkupString HighlightSearch(string line)
    {
        if (string.IsNullOrEmpty(_searchText))
            return new MarkupString(System.Web.HttpUtility.HtmlEncode(line));

        var encoded = System.Web.HttpUtility.HtmlEncode(line);
        var highlighted = encoded.Replace(
            _searchText,
            $"<mark>{_searchText}</mark>",
            StringComparison.OrdinalIgnoreCase);
        return new MarkupString(highlighted);
    }
}

<style>
    .log-viewer {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 300px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', monospace;
    }

    .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        background: #333;
        border-bottom: 1px solid #444;
    }

    .log-title {
        font-weight: 500;
        color: #fff;
    }

    .log-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .search-input {
        padding: 0.25rem 0.5rem;
        border: 1px solid #555;
        border-radius: 4px;
        background: #2d2d2d;
        color: #fff;
        font-size: 0.85rem;
        width: 150px;
    }

    .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .btn-icon:hover {
        opacity: 1;
    }

    .auto-scroll {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.85rem;
        color: #aaa;
        cursor: pointer;
    }

    .log-content {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem 0;
    }

    .empty-log {
        text-align: center;
        padding: 2rem;
        color: #666;
    }

    .log-line {
        display: flex;
        padding: 0.1rem 1rem;
        font-size: 0.85rem;
        line-height: 1.5;
    }

    .log-line:hover {
        background: #2d2d2d;
    }

    .log-line.error {
        background: rgba(220, 53, 69, 0.2);
        color: #f8d7da;
    }

    .log-line.warning {
        background: rgba(255, 193, 7, 0.2);
        color: #fff3cd;
    }

    .log-line.progress {
        color: #98c379;
    }

    .line-number {
        min-width: 40px;
        text-align: right;
        margin-right: 1rem;
        color: #666;
        user-select: none;
    }

    .line-content {
        flex: 1;
        word-break: break-all;
    }

    .line-content mark {
        background: #ffeb3b;
        color: #000;
        padding: 0 2px;
        border-radius: 2px;
    }

    .log-footer {
        padding: 0.5rem 1rem;
        background: #333;
        border-top: 1px solid #444;
        font-size: 0.8rem;
        color: #888;
    }
</style>
