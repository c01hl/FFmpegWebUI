@page "/templates/admin"
@using FFmpegWebUI.Models
@using FFmpegWebUI.Services
@using FFmpegWebUI.Components.Shared
@inject ITemplateService TemplateService
@rendermode InteractiveServer

<PageTitle>é¢„è®¾æ¨¡æ¿ç®¡ç† - FFmpeg Web UI</PageTitle>

<div class="admin-container">
    <div class="admin-header">
        <h1>ğŸ”§ é¢„è®¾æ¨¡æ¿ç®¡ç†</h1>
        <span class="admin-badge">ç®¡ç†å‘˜å…¥å£</span>
    </div>

    <div class="warning-banner">
        âš ï¸ è­¦å‘Šï¼šæ­¤é¡µé¢ç”¨äºç¼–è¾‘ç³»ç»Ÿé¢„è®¾æ¨¡æ¿ã€‚ä¿®æ”¹åéœ€è¦æ¸…é™¤æ•°æ®åº“ä¸­çš„ç³»ç»Ÿæ¨¡æ¿æ‰èƒ½é‡æ–°åˆå§‹åŒ–ã€‚
    </div>

    <div class="action-bar">
        <button class="btn-primary" @onclick="CreateSystemTemplate">
            â• åˆ›å»ºé¢„è®¾æ¨¡æ¿
        </button>
        <button class="btn-danger" @onclick="ShowResetConfirm">
            ğŸ”„ é‡ç½®æ‰€æœ‰é¢„è®¾æ¨¡æ¿
        </button>
    </div>

    <div class="templates-section">
        <h2>ç³»ç»Ÿé¢„è®¾æ¨¡æ¿ (@_systemTemplates.Count)</h2>
        
        @if (_isLoading)
        {
            <div class="loading">åŠ è½½ä¸­...</div>
        }
        else
        {
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>åç§°</th>
                        <th>åˆ†ç±»</th>
                        <th>è¾“å‡ºæ ¼å¼</th>
                        <th>ç¡¬ä»¶åŠ é€Ÿ</th>
                        <th>æ’åº</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var template in _systemTemplates.OrderBy(t => t.SortOrder))
                    {
                        <tr>
                            <td>@template.Name</td>
                            <td>@template.Category</td>
                            <td>.@template.OutputExtension</td>
                            <td>
                                @if (template.RequiresHardwareAcceleration)
                                {
                                    <span class="badge hw">@template.RequiredEncoder</span>
                                }
                                else
                                {
                                    <span class="muted">å¦</span>
                                }
                            </td>
                            <td>@template.SortOrder</td>
                            <td>
                                <button class="btn-sm" @onclick="() => EditSystemTemplate(template)">âœï¸ ç¼–è¾‘</button>
                                <button class="btn-sm danger" @onclick="() => DeleteSystemTemplate(template)">ğŸ—‘ï¸ åˆ é™¤</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>

    @if (!string.IsNullOrEmpty(_message))
    {
        <div class="message @_messageClass">@_message</div>
    }
</div>

@* ç³»ç»Ÿæ¨¡æ¿ç¼–è¾‘å™¨ *@
<div class="system-editor @(_showEditor ? "visible" : "")">
    <div class="editor-overlay" @onclick="CloseEditor"></div>
    <div class="editor-panel">
        <div class="editor-header">
            <h2>@(_isCreating ? "åˆ›å»ºé¢„è®¾æ¨¡æ¿" : "ç¼–è¾‘é¢„è®¾æ¨¡æ¿")</h2>
            <button class="close-btn" @onclick="CloseEditor">âœ•</button>
        </div>

        <div class="editor-body">
            <div class="form-group @(HasFieldError("Name") ? "has-error" : "")">
                <label>æ¨¡æ¿åç§° *</label>
                <input type="text" @bind="_editingTemplate.Name" @ref="_adminNameInput" />
                @if (HasFieldError("Name"))
                {
                    <span class="field-error">@GetFieldError("Name")</span>
                }
            </div>

            <div class="form-group">
                <label>æè¿°</label>
                <textarea @bind="_editingTemplate.Description" rows="2"></textarea>
            </div>

            <div class="form-group @(HasFieldError("Category") ? "has-error" : "")">
                <label>åˆ†ç±» *</label>
                <input type="text" @bind="_editingTemplate.Category" @ref="_adminCategoryInput" list="categories" />
                <datalist id="categories">
                    @foreach (var cat in _categories)
                    {
                        <option value="@cat" />
                    }
                </datalist>
                @if (HasFieldError("Category"))
                {
                    <span class="field-error">@GetFieldError("Category")</span>
                }
            </div>

            <div class="form-group @(HasFieldError("CommandArgs") ? "has-error" : "")">
                <label>FFmpeg å‘½ä»¤å‚æ•° *</label>
                <textarea @bind="_editingTemplate.CommandArgs" @ref="_adminCommandArgsInput" rows="4"></textarea>
                <span class="help-text">å ä½ç¬¦ï¼š{"{input}"} è¾“å…¥æ–‡ä»¶, {"{output}"} è¾“å‡ºæ–‡ä»¶</span>
                @if (HasFieldError("CommandArgs"))
                {
                    <span class="field-error">@GetFieldError("CommandArgs")</span>
                }
            </div>

            <div class="form-row">
                <div class="form-group half @(HasFieldError("OutputExtension") ? "has-error" : "")">
                    <label>è¾“å‡ºæ‰©å±•å *</label>
                    <input type="text" @bind="_editingTemplate.OutputExtension" @ref="_adminOutputExtInput" />
                    @if (HasFieldError("OutputExtension"))
                    {
                        <span class="field-error">@GetFieldError("OutputExtension")</span>
                    }
                </div>
                <div class="form-group half">
                    <label>æ’åºæƒé‡</label>
                    <input type="number" @bind="_editingTemplate.SortOrder" />
                </div>
            </div>

            <div class="form-group">
                <label>æ”¯æŒçš„è¾“å…¥æ ¼å¼ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                <input type="text" @bind="_inputFormatsText" placeholder="mp4, avi, mkv" />
            </div>

            <div class="form-group checkbox">
                <label>
                    <input type="checkbox" @bind="_editingTemplate.RequiresHardwareAcceleration" />
                    éœ€è¦ç¡¬ä»¶åŠ é€Ÿ
                </label>
            </div>

            @if (_editingTemplate.RequiresHardwareAcceleration)
            {
                <div class="form-group">
                    <label>æ‰€éœ€ç¼–ç å™¨</label>
                    <select @bind="_editingTemplate.RequiredEncoder">
                        <option value="">é€‰æ‹©ç¼–ç å™¨</option>
                        <option value="h264_nvenc">NVIDIA NVENC H.264</option>
                        <option value="hevc_nvenc">NVIDIA NVENC H.265</option>
                        <option value="h264_qsv">Intel QSV H.264</option>
                        <option value="hevc_qsv">Intel QSV H.265</option>
                        <option value="h264_amf">AMD AMF H.264</option>
                        <option value="hevc_amf">AMD AMF H.265</option>
                    </select>
                </div>
            }

            @if (!string.IsNullOrEmpty(_saveError))
            {
                <div class="error-message">@_saveError</div>
            }
        </div>

        <div class="editor-footer">
            <button class="btn-secondary" @onclick="CloseEditor">å–æ¶ˆ</button>
            <button class="btn-primary" @onclick="SaveSystemTemplate">ä¿å­˜</button>
        </div>
    </div>
</div>

@* é‡ç½®ç¡®è®¤å¯¹è¯æ¡† *@
@if (_showResetConfirm)
{
    <div class="confirm-dialog">
        <div class="confirm-overlay" @onclick="() => _showResetConfirm = false"></div>
        <div class="confirm-panel">
            <h3>âš ï¸ ç¡®è®¤é‡ç½®</h3>
            <p>è¿™å°†åˆ é™¤æ‰€æœ‰ç³»ç»Ÿé¢„è®¾æ¨¡æ¿ï¼Œç„¶åé‡æ–°ä»ä»£ç åˆå§‹åŒ–ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</p>
            <div class="confirm-actions">
                <button class="btn-secondary" @onclick="() => _showResetConfirm = false">å–æ¶ˆ</button>
                <button class="btn-danger" @onclick="ResetSystemTemplates">ç¡®è®¤é‡ç½®</button>
            </div>
        </div>
    </div>
}

@code {
    private List<CommandTemplate> _systemTemplates = [];
    private List<string> _categories = [];
    private bool _isLoading = true;
    private string _message = string.Empty;
    private string _messageClass = string.Empty;
    
    private bool _showEditor;
    private bool _isCreating;
    private CommandTemplate _editingTemplate = new();
    private string _inputFormatsText = string.Empty;
    private string _saveError = string.Empty;
    private Dictionary<string, string> _fieldErrors = [];
    
    // è¾“å…¥æ¡†å¼•ç”¨
    private ElementReference _adminNameInput;
    private ElementReference _adminCategoryInput;
    private ElementReference _adminCommandArgsInput;
    private ElementReference _adminOutputExtInput;
    
    private bool _showResetConfirm;
    
    private bool HasFieldError(string field) => _fieldErrors.ContainsKey(field);
    private string GetFieldError(string field) => _fieldErrors.TryGetValue(field, out var error) ? error : string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplates();
    }

    private async Task LoadTemplates()
    {
        _isLoading = true;
        var all = await TemplateService.GetAllTemplatesAsync();
        _systemTemplates = all.Where(t => t.Type == TemplateType.System).ToList();
        _categories = all.Select(t => t.Category).Distinct().Where(c => !string.IsNullOrEmpty(c)).OrderBy(c => c).ToList();
        _isLoading = false;
    }

    private void CreateSystemTemplate()
    {
        _editingTemplate = new CommandTemplate
        {
            Type = TemplateType.System,
            SortOrder = _systemTemplates.Count
        };
        _inputFormatsText = string.Empty;
        _isCreating = true;
        _saveError = string.Empty;
        _fieldErrors.Clear();
        _showEditor = true;
    }

    private void EditSystemTemplate(CommandTemplate template)
    {
        _editingTemplate = new CommandTemplate
        {
            Id = template.Id,
            Name = template.Name,
            Description = template.Description,
            Category = template.Category,
            CommandArgs = template.CommandArgs,
            OutputExtension = template.OutputExtension,
            SupportedInputFormats = [.. template.SupportedInputFormats],
            RequiresHardwareAcceleration = template.RequiresHardwareAcceleration,
            RequiredEncoder = template.RequiredEncoder,
            SortOrder = template.SortOrder,
            Type = TemplateType.System,
            CreatedAt = template.CreatedAt
        };
        _inputFormatsText = string.Join(", ", template.SupportedInputFormats);
        _isCreating = false;
        _saveError = string.Empty;
        _fieldErrors.Clear();
        _showEditor = true;
    }

    private async Task SaveSystemTemplate()
    {
        _saveError = string.Empty;
        _fieldErrors.Clear();

        // éªŒè¯å¹¶æ”¶é›†æ‰€æœ‰é”™è¯¯
        if (string.IsNullOrWhiteSpace(_editingTemplate.Name))
        {
            _fieldErrors["Name"] = "è¯·è¾“å…¥æ¨¡æ¿åç§°";
        }
        if (string.IsNullOrWhiteSpace(_editingTemplate.Category))
        {
            _fieldErrors["Category"] = "è¯·è¾“å…¥æ¨¡æ¿åˆ†ç±»";
        }
        if (string.IsNullOrWhiteSpace(_editingTemplate.CommandArgs))
        {
            _fieldErrors["CommandArgs"] = "è¯·è¾“å…¥ FFmpeg å‘½ä»¤å‚æ•°";
        }
        if (string.IsNullOrWhiteSpace(_editingTemplate.OutputExtension))
        {
            _fieldErrors["OutputExtension"] = "è¯·è¾“å…¥è¾“å‡ºæ‰©å±•å";
        }

        // å¦‚æœæœ‰é”™è¯¯ï¼Œèšç„¦åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯å­—æ®µ
        if (_fieldErrors.Count > 0)
        {
            StateHasChanged();
            await FocusFirstFieldError();
            return;
        }

        _editingTemplate.SupportedInputFormats = _inputFormatsText
            .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
            .Select(f => f.TrimStart('.').ToLower())
            .ToList();

        _editingTemplate.UpdatedAt = DateTime.UtcNow;

        try
        {
            if (_isCreating)
            {
                _editingTemplate.CreatedAt = DateTime.UtcNow;
                await TemplateService.CreateSystemTemplateAsync(_editingTemplate);
                _message = $"âœ“ é¢„è®¾æ¨¡æ¿ \"{_editingTemplate.Name}\" å·²åˆ›å»º";
            }
            else
            {
                await TemplateService.UpdateSystemTemplateAsync(_editingTemplate);
                _message = $"âœ“ é¢„è®¾æ¨¡æ¿ \"{_editingTemplate.Name}\" å·²æ›´æ–°";
            }
            _messageClass = "success";
            _showEditor = false;
            await LoadTemplates();
        }
        catch (Exception ex)
        {
            _saveError = $"ä¿å­˜å¤±è´¥: {ex.Message}";
        }
    }

    private async Task FocusFirstFieldError()
    {
        await Task.Delay(50); // ç­‰å¾… DOM æ›´æ–°
        
        if (_fieldErrors.ContainsKey("Name"))
            await _adminNameInput.FocusAsync();
        else if (_fieldErrors.ContainsKey("Category"))
            await _adminCategoryInput.FocusAsync();
        else if (_fieldErrors.ContainsKey("CommandArgs"))
            await _adminCommandArgsInput.FocusAsync();
        else if (_fieldErrors.ContainsKey("OutputExtension"))
            await _adminOutputExtInput.FocusAsync();
    }

    private async Task DeleteSystemTemplate(CommandTemplate template)
    {
        var success = await TemplateService.DeleteSystemTemplateAsync(template.Id);
        if (success)
        {
            _message = $"âœ“ é¢„è®¾æ¨¡æ¿ \"{template.Name}\" å·²åˆ é™¤";
            _messageClass = "success";
            await LoadTemplates();
        }
        else
        {
            _message = "åˆ é™¤å¤±è´¥";
            _messageClass = "error";
        }
    }

    private void ShowResetConfirm()
    {
        _showResetConfirm = true;
    }

    private async Task ResetSystemTemplates()
    {
        _showResetConfirm = false;
        await TemplateService.ResetSystemTemplatesAsync();
        _message = "âœ“ é¢„è®¾æ¨¡æ¿å·²é‡ç½®";
        _messageClass = "success";
        await LoadTemplates();
    }

    private void CloseEditor()
    {
        _showEditor = false;
        _fieldErrors.Clear();
    }
}

<style>
    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .admin-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .admin-header h1 {
        margin: 0;
    }

    .admin-badge {
        background: #dc3545;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .warning-banner {
        background: #fff3cd;
        color: #856404;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border: 1px solid #ffeeba;
    }

    .action-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .templates-section {
        background: var(--card-bg, white);
        border: 1px solid var(--border-color, #ddd);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .templates-section h2 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        color: var(--text-primary, #333);
    }

    .admin-table {
        width: 100%;
        border-collapse: collapse;
    }

    .admin-table th,
    .admin-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color, #ddd);
    }

    .admin-table th {
        background: var(--light-bg, #f8f9fa);
        font-weight: 500;
        color: var(--text-secondary, #666);
    }

    .admin-table td {
        color: var(--text-primary, #333);
    }

    .badge.hw {
        background: #cce5ff;
        color: #004085;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .muted {
        color: var(--text-muted, #888);
    }

    .btn-sm {
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        background: var(--light-bg, #f8f9fa);
        border: 1px solid var(--border-color, #ddd);
        color: var(--text-primary, #333);
        margin-right: 0.25rem;
    }

    .btn-sm:hover {
        background: var(--card-bg, #e9ecef);
    }

    .btn-sm.danger {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .btn-sm.danger:hover {
        background: #f5c6cb;
    }

    .btn-primary {
        padding: 0.6rem 1.25rem;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        padding: 0.6rem 1.25rem;
        background: var(--light-bg, #f8f9fa);
        border: 1px solid var(--border-color, #ddd);
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-primary, #333);
    }

    .btn-danger {
        padding: 0.6rem 1.25rem;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary, #666);
    }

    .message {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        z-index: 100;
    }

    .message.success {
        background: #d4edda;
        color: #155724;
    }

    .message.error {
        background: #f8d7da;
        color: #721c24;
    }

    /* ç¼–è¾‘å™¨æ ·å¼ */
    .system-editor {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
    }

    .system-editor.visible {
        display: block;
    }

    .editor-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
    }

    .editor-panel {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        background: var(--card-bg, white);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        color: var(--text-primary, #333);
    }

    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color, #ddd);
        background: var(--light-bg, #f8f9fa);
    }

    .editor-header h2 {
        margin: 0;
        font-size: 1.25rem;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary, #666);
    }

    .editor-body {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid var(--border-color, #ddd);
        border-radius: 4px;
        font-size: 0.95rem;
        background: var(--input-bg, white);
        color: var(--text-primary, #333);
    }

    .form-group.checkbox label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .form-group.checkbox input {
        width: auto;
    }

    .form-row {
        display: flex;
        gap: 1rem;
    }

    .form-group.half {
        flex: 1;
    }

    .help-text {
        display: block;
        font-size: 0.8rem;
        color: var(--text-muted, #888);
        margin-top: 0.25rem;
    }

    .form-group.has-error input,
    .form-group.has-error textarea,
    .form-group.has-error select {
        border-color: #dc3545;
        background-color: #fff8f8;
    }

    .field-error {
        display: block;
        font-size: 0.85rem;
        color: #dc3545;
        margin-top: 0.25rem;
    }

    .error-message {
        padding: 0.75rem;
        background: #f8d7da;
        color: #721c24;
        border-radius: 4px;
    }

    .editor-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color, #ddd);
        background: var(--light-bg, #f8f9fa);
    }

    /* ç¡®è®¤å¯¹è¯æ¡† */
    .confirm-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1001;
    }

    .confirm-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
    }

    .confirm-panel {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--card-bg, white);
        padding: 1.5rem;
        border-radius: 8px;
        min-width: 350px;
        color: var(--text-primary, #333);
    }

    .confirm-panel h3 {
        margin: 0 0 1rem 0;
    }

    .confirm-panel p {
        margin: 0 0 1.5rem 0;
        color: var(--text-secondary, #666);
    }

    .confirm-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }
</style>
