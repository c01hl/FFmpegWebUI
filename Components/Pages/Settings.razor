@page "/settings"
@using FFmpegWebUI.Models
@using FFmpegWebUI.Services
@using FFmpegWebUI.Components.Shared
@inject ISettingsService SettingsService
@inject IFFmpegService FFmpegService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>è®¾ç½® - FFmpeg Web UI</PageTitle>

<div class="settings-container">
    <h1>âš™ï¸ è®¾ç½®</h1>

    @if (_isLoading)
    {
        <div class="loading">åŠ è½½ä¸­...</div>
    }
    else
    {
        <div class="settings-sections">
            <section class="settings-section">
                <h2>ğŸ“ FFmpeg è·¯å¾„</h2>
                <FileSelector Label="FFmpeg å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„"
                              @bind-Value="_settings.FFmpegPath"
                              Placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ç³»ç»Ÿ PATH ä¸­çš„ ffmpeg"
                              ValidateExists="false"
                              ShowFileInfo="true" />
                <div class="form-group inline-action">
                    <button class="btn-test" @onclick="TestFFmpegPath">ğŸ” æµ‹è¯• FFmpeg</button>
                    @if (_ffmpegTestResult != null)
                    {
                        <span class="test-result @(_ffmpegTestResult.Value ? "success" : "error")">
                            @(_ffmpegTestResult.Value ? "âœ“ FFmpeg å¯ç”¨" : "âœ— FFmpeg ä¸å¯ç”¨")
                        </span>
                    }
                </div>
                <span class="help-text">
                    ä¾‹å¦‚ï¼šC:\ffmpeg\bin\ffmpeg.exe æˆ– /usr/local/bin/ffmpeg
                </span>

                <FileSelector Label="ffprobe å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„"
                              @bind-Value="_settings.FFprobePath"
                              Placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ç³»ç»Ÿ PATH ä¸­çš„ ffprobe"
                              ValidateExists="false"
                              ShowFileInfo="true" />
            </section>

            <section class="settings-section">
                <h2>ğŸ“ è¾“å‡ºè®¾ç½®</h2>
                <FileSelector Label="é»˜è®¤è¾“å‡ºç›®å½•"
                              @bind-Value="_settings.DefaultOutputDirectory"
                              Placeholder="é€‰æ‹©é»˜è®¤è¾“å‡ºç›®å½•"
                              IsDirectory="true"
                              ValidateExists="false" />

                <div class="form-group">
                    <label>è¾“å‡ºæ–‡ä»¶å‘½åè§„åˆ™</label>
                    <select @bind="_settings.OutputNaming">
                        <option value="@OutputNamingRule.Original">ä¿æŒåŸå</option>
                        <option value="@OutputNamingRule.Suffix">æ·»åŠ åç¼€</option>
                    </select>
                </div>

                @if (_settings.OutputNaming == OutputNamingRule.Suffix)
                {
                    <div class="form-group">
                        <label>è¾“å‡ºæ–‡ä»¶åç¼€</label>
                        <input type="text" @bind="_settings.OutputSuffix"
                               placeholder="_converted" />
                        <span class="help-text">
                            ç¤ºä¾‹ï¼šåŸæ–‡ä»¶ video.mp4 â†’ video@(_settings.OutputSuffix).mp4
                        </span>
                    </div>
                }

                <div class="form-group">
                    <label>æ–‡ä»¶å·²å­˜åœ¨æ—¶çš„å¤„ç†æ–¹å¼</label>
                    <select @bind="_settings.FileExistsAction">
                        <option value="@FileExistsAction.Ask">è¯¢é—®ç”¨æˆ·</option>
                        <option value="@FileExistsAction.Overwrite">è¦†ç›–</option>
                        <option value="@FileExistsAction.Skip">è·³è¿‡</option>
                        <option value="@FileExistsAction.Rename">é‡å‘½å</option>
                    </select>
                </div>
            </section>

            <section class="settings-section">
                <h2>ğŸš€ æ€§èƒ½è®¾ç½®</h2>
                <div class="form-group checkbox">
                    <label>
                        <input type="checkbox" @bind="_settings.PreferHardwareAcceleration" />
                        ä¼˜å…ˆä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ
                    </label>
                    <span class="help-text">
                        å¯ç”¨åå°†è‡ªåŠ¨é€‰æ‹©å¯ç”¨çš„ç¡¬ä»¶ç¼–ç å™¨ï¼ˆNVENCã€QSVã€AMFï¼‰
                    </span>
                </div>
            </section>

            <section class="settings-section">
                <h2>ğŸ§¹ æ•°æ®ç®¡ç†</h2>
                <div class="form-group">
                    <label>ä»»åŠ¡å†å²ä¿ç•™å¤©æ•°</label>
                    <input type="number" @bind="_settings.TaskHistoryRetentionDays" min="0" max="365" />
                    <span class="help-text">
                        è®¾ç½®ä¸º 0 è¡¨ç¤ºä¸è‡ªåŠ¨æ¸…ç†å†å²è®°å½•
                    </span>
                </div>
            </section>

            <section class="settings-section">
                <h2>ğŸ¨ ç•Œé¢è®¾ç½®</h2>
                <div class="form-group">
                    <label>ä¸»é¢˜</label>
                    <select @bind="_settings.Theme">
                        <option value="System">è·Ÿéšç³»ç»Ÿ</option>
                        <option value="Light">æµ…è‰²</option>
                        <option value="Dark">æ·±è‰²</option>
                    </select>
                </div>
            </section>
        </div>

        <div class="action-section">
            <button class="btn-primary" @onclick="SaveSettings" disabled="@_isSaving">
                @(_isSaving ? "ä¿å­˜ä¸­..." : "ğŸ’¾ ä¿å­˜è®¾ç½®")
            </button>
            <button class="btn-secondary" @onclick="ResetSettings">
                ğŸ”„ æ¢å¤é»˜è®¤
            </button>
        </div>

        @if (!string.IsNullOrEmpty(_message))
        {
            <div class="message @_messageClass">@_message</div>
        }
    }
</div>

@code {
    private AppSettings _settings = new();
    private string _originalTheme = "System";
    private bool _isLoading = true;
    private bool _isSaving;
    private bool? _ffmpegTestResult;
    private string _message = string.Empty;
    private string _messageClass = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        _isLoading = true;
        _settings = await SettingsService.GetSettingsAsync();
        _originalTheme = _settings.Theme;
        _isLoading = false;
    }

    private async Task SaveSettings()
    {
        _isSaving = true;
        _message = string.Empty;
        StateHasChanged();

        try
        {
            var themeChanged = _settings.Theme != _originalTheme;
            await SettingsService.SaveSettingsAsync(_settings);
            _message = "âœ“ è®¾ç½®å·²ä¿å­˜";
            _messageClass = "success";
            
            // å¦‚æœä¸»é¢˜æ”¹å˜ï¼Œåˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ–°ä¸»é¢˜
            if (themeChanged)
            {
                _message = "âœ“ è®¾ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨åº”ç”¨æ–°ä¸»é¢˜...";
                StateHasChanged();
                await Task.Delay(500);
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            _message = $"ä¿å­˜å¤±è´¥: {ex.Message}";
            _messageClass = "error";
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ResetSettings()
    {
        var oldTheme = _settings.Theme;
        await SettingsService.ResetToDefaultAsync();
        await LoadSettings();
        _message = "âœ“ å·²æ¢å¤é»˜è®¤è®¾ç½®";
        _messageClass = "success";
        
        // å¦‚æœä¸»é¢˜æ”¹å˜ï¼Œåˆ·æ–°é¡µé¢
        if (_settings.Theme != oldTheme)
        {
            _message = "âœ“ å·²æ¢å¤é»˜è®¤è®¾ç½®ï¼Œæ­£åœ¨åº”ç”¨ä¸»é¢˜...";
            StateHasChanged();
            await Task.Delay(500);
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        }
    }

    private async Task TestFFmpegPath()
    {
        _ffmpegTestResult = null;
        StateHasChanged();

        _ffmpegTestResult = await SettingsService.ValidateFFmpegPathAsync(_settings.FFmpegPath);
        StateHasChanged();
    }
}

<style>
    .settings-container {
        max-width: 800px;
        margin: 0 auto;
    }

    h1 {
        margin-bottom: 2rem;
    }

    .loading {
        text-align: center;
        padding: 3rem;
        color: #666;
    }

    .settings-sections {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .settings-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
    }

    .settings-section h2 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        color: #333;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #333;
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.95rem;
    }

    .form-group.checkbox label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-weight: normal;
    }

    .form-group.checkbox input {
        width: auto;
    }

    .form-group.inline-action {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: -0.5rem;
        margin-bottom: 1rem;
    }

    .btn-test {
        padding: 0.5rem 1rem;
        background: #17a2b8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .btn-test:hover {
        background: #138496;
    }

    .test-result {
        font-size: 0.9rem;
        font-weight: 500;
    }

    .test-result.success {
        color: #28a745;
    }

    .test-result.error {
        color: #dc3545;
    }

    .help-text {
        display: block;
        font-size: 0.8rem;
        color: #888;
        margin-top: 0.25rem;
    }

    .action-section {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .btn-primary,
    .btn-secondary {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-size: 0.95rem;
        cursor: pointer;
    }

    .btn-primary {
        background: #007bff;
        color: white;
        border: none;
    }

    .btn-primary:hover:not(:disabled) {
        background: #0056b3;
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
        border: none;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    .message {
        padding: 1rem;
        border-radius: 6px;
    }

    .message.success {
        background: #d4edda;
        color: #155724;
    }

    .message.error {
        background: #f8d7da;
        color: #721c24;
    }
</style>
